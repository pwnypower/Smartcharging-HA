blueprint:
  name: "Frank Energie - Smart Battery Manager v1.4.4 (Language Fix)"
  description: >
    **Fix v1.4.4:** Fixed logic bug where daytime hours were labeled as 'Morning' in the report. Added Language Selector.
    
    STRATEGY:
    - Weighted Peak Analysis & Profit Margins.
    - Morning Guarantee (Night only).
    - Smart Hold & Switch-Only Discharge.
  domain: automation
  input:
    # --- GENERAL ---
    language:
      name: "Language / Taal"
      description: "Select the language for notifications."
      default: "en"
      selector:
        select:
          options:
            - label: "English"
              value: "en"
            - label: "Nederlands"
              value: "nl"

    # --- BASIC ENTITIES ---
    battery_reserve_switch:
      name: "Switch: Force Charge"
      selector:
        entity:
          domain: switch
    battery_soc_sensor:
      name: "Sensor: Battery SoC"
      selector:
        entity:
          domain: sensor
          device_class: battery
    target_soc_number:
      name: "Entity: Target SoC"
      selector:
        entity:
          domain: number
    frank_price_sensor:
      name: "Sensor: Frank Energy Prices"
      selector:
        entity:
          domain: sensor

    # --- MEMORY ---
    last_price_helper:
      name: "Helper: Last Purchase Price"
      selector:
        entity:
          domain: input_number

    # --- STRATEGY ---
    peak_hours_count:
      name: "Peak Analysis Window"
      default: 3
      selector:
        number:
          min: 1
          max: 6
    
    buffer_discount_percentage:
      name: "Buffer Discount (%)"
      description: "Charge if Price < Peak * (1 - Discount%)."
      default: 40
      selector:
        number:
          min: 10
          max: 90
          unit_of_measurement: "%"

    min_discharge_margin:
      name: "Min. Discharge Profit (%)"
      description: "Discharge if Price > Buy Price * (1 + Margin%)."
      default: 20
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"

    # --- MORNING GUARANTEE ---
    target_soc_morning_min:
      name: "Morning Guarantee (%)"
      default: 50
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"

    min_base_soc:
      name: "Absolute Minimum SoC (%)"
      default: 15
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"

    # --- BOOST & NOTIFICATIONS ---
    boost_switch:
      name: "Switch: Manual Boost"
      default: []
      selector:
        entity:
          domain: input_boolean
    
    notify_device:
      name: "Notification Device"
      default: []
      selector:
        device:
          integration: mobile_app

    # --- TARGETS ---
    target_soc_winter:
      name: "Target SoC (Winter)"
      default: 90
      selector:
        number:
          min: 10
          max: 100
    target_soc_summer:
      name: "Target SoC (Summer)"
      default: 30
      selector:
        number:
          min: 10
          max: 100
    summer_solar_threshold:
      name: "Summer Solar Threshold (kWh)"
      default: 15
      selector:
        number:
          min: 0
          max: 100

    # --- SYSTEM ---
    solar_forecast_today:
      name: "Sensor: Solar Forecast Today"
      selector:
        entity:
          domain: sensor
    solar_forecast_tomorrow:
      name: "Sensor: Solar Forecast Tomorrow"
      selector:
        entity:
          domain: sensor
    battery_capacity_kwh:
      name: "Battery Capacity (kWh)"
      default: 10
      selector:
        number:
          min: 1
          max: 100
          step: 0.1
    charge_power_kw:
      name: "Charge Speed (kW)"
      default: 3.0
      selector:
        number:
          min: 0.1
          max: 22
          step: 0.1
    safety_factor:
      name: "BMS Safety Factor"
      default: 1.5
      selector:
        number:
          min: 1.0
          max: 4.0
          step: 0.1
    max_price_cap:
      name: "Absolute Max Price (â‚¬)"
      default: 0.35
      selector:
        number:
          min: 0
          max: 2.0
          step: 0.01
    emergency_soc:
      name: "Emergency SoC (%)"
      default: 10
      selector:
        number:
          min: 0
          max: 100

    # --- TIME SLOTS & REPORTING ---
    night_start:
      name: "Night Slot Start"
      default: "00:00:00"
      selector:
        time:
    night_end:
      name: "Night Slot End"
      default: "06:00:00"
      selector:
        time:
    day_start:
      name: "Day Slot Start"
      default: "12:00:00"
      selector:
        time:
    day_end:
      name: "Day Slot End"
      default: "15:00:00"
      selector:
        time:
    report_time_evening:
      name: "Report Time (Evening)"
      default: "21:30:00"
      selector:
        time:
    report_time_morning:
      name: "Report Time (Morning)"
      default: "08:00:00"
      selector:
        time:

variables:
  # Inputs
  battery_reserve_switch: !input battery_reserve_switch
  battery_soc_sensor: !input battery_soc_sensor
  target_soc_number: !input target_soc_number
  frank_price_sensor: !input frank_price_sensor
  last_price_helper: !input last_price_helper
  boost_switch: !input boost_switch
  notify_device: !input notify_device
  peak_hours_count: !input peak_hours_count
  buffer_discount_percentage: !input buffer_discount_percentage
  min_discharge_margin: !input min_discharge_margin
  min_base_soc: !input min_base_soc
  target_soc_morning_min: !input target_soc_morning_min
  target_soc_winter: !input target_soc_winter
  target_soc_summer: !input target_soc_summer
  summer_solar_threshold: !input summer_solar_threshold
  solar_forecast_today: !input solar_forecast_today
  solar_forecast_tomorrow: !input solar_forecast_tomorrow
  battery_capacity_kwh: !input battery_capacity_kwh
  charge_power_kw: !input charge_power_kw
  safety_factor: !input safety_factor
  max_price_cap: !input max_price_cap
  emergency_soc: !input emergency_soc
  night_start: !input night_start
  night_end: !input night_end
  day_start: !input day_start
  day_end: !input day_end
  report_time_evening: !input report_time_evening
  report_time_morning: !input report_time_morning
  language: !input language

trigger:
  - platform: time_pattern
    minutes: "/5"
    id: "timer"
  - platform: time
    at: !input report_time_evening
    id: "report"
  - platform: time
    at: !input report_time_morning
    id: "report"
  - platform: state
    entity_id: !input frank_price_sensor
    id: "price_change"
  
  # Boost Trigger
  - platform: template
    value_template: "{{ !input boost_switch != [] and is_state(!input boost_switch, 'on') }}"
    id: "boost"

action:
  - variables:
      current_soc: "{{ states(battery_soc_sensor) | float(0) }}"
      current_price: "{{ states(frank_price_sensor) | float(0) }}"
      last_paid_price: "{{ states(last_price_helper) | float(0) }}"
      is_boost_active: "{{ boost_switch != [] and is_state(boost_switch, 'on') }}"
      has_notify_device: "{{ notify_device != [] }}"

      # --- 1. TIME SLOT LOGIC ---
      now_h: "{{ now().hour }}"
      ns: "{{ night_start.split(':')[0] | int }}"
      ne: "{{ night_end.split(':')[0] | int }}"
      ds: "{{ day_start.split(':')[0] | int }}"
      de: "{{ day_end.split(':')[0] | int }}"
      
      # Determine if a slot crosses midnight (Start > End)
      night_crosses: "{{ ns > ne }}"
      day_crosses: "{{ ds > de }}"

      is_night_now: >-
        {% if night_crosses %} {{ now_h >= ns or now_h < ne }}
        {% else %}             {{ now_h >= ns and now_h < ne }}
        {% endif %}
      
      is_in_slot: >-
        {% if night_crosses %} {% set night_active = (now_h >= ns or now_h < ne) %}
        {% else %}             {% set night_active = (now_h >= ns and now_h < ne) %}
        {% endif %}
        {% if day_crosses %}   {% set day_active = (now_h >= ds or now_h < de) %}
        {% else %}             {% set day_active = (now_h >= ds and now_h < de) %}
        {% endif %}
        {{ night_active or day_active }}

      # --- 2. DATA PARSEN ---
      raw: "{{ state_attr(frank_price_sensor, 'prices') }}"
      prices_json: >-
        {% if raw %}
          {% set text = raw | string %}
          {% set matches = text | regex_findall(
            "datetime\\.datetime\\((\\d+), (\\d+), (\\d+), (\\d+), (\\d+).*?price': ([0-9.]+)"
          ) %}
          [
          {%- for m in matches %}
            {% set y = m[0]|int %}
            {% set mo = m[1]|int %}
            {% set d = m[2]|int %}
            {% set h = m[3]|int %}
            {% set mn = m[4]|int %}
            {% set price = m[5]|float %}
            {% set iso_utc = "%04d-%02d-%02dT%02d:%02d:00+00:00" | format(y, mo, d, h, mn) %}
            {% set local_dt = iso_utc | as_datetime | as_local %}
            {
              "local_hour": {{ local_dt.hour }},
              "day_str": "{{ 'Today' if local_dt.date() == now().date() else 'Tomorrow' }}",
              "ts": {{ as_timestamp(local_dt) }},
              "price": {{ price }}
            }{{ "," if not loop.last }}
          {%- endfor %}
          ]
        {% else %} [] {% endif %}

      # --- 3. ANALYSIS (AM/PM PEAKS) ---
      filtered_data: >-
        {% set output = namespace(price_list=[], slot_data=[], am_prices=[], pm_prices=[]) %}
        {% set now_ts = as_timestamp(now()) %}
        {% set history_cutoff = now_ts - 3600 %}
        
        {% if prices_json %}
           {% for item in prices_json %}
              {% if item.ts >= history_cutoff %}
                  {# Collect all for sorting #}
                  {% set output.price_list = output.price_list + [item.price] %}
                  {% set output.slot_data = output.slot_data + [item] %}
                  
                  {# Split AM/PM for Peak Analysis #}
                  {% if item.local_hour < 12 %}
                     {% set output.am_prices = output.am_prices + [item.price] %}
                  {% else %}
                     {% set output.pm_prices = output.pm_prices + [item.price] %}
                  {% endif %}
              {% endif %}
           {% endfor %}
        {% endif %}
        
        {# Calculate Weighted Peaks (Top X) #}
        {% set sort_am = output.am_prices | sort(reverse=True) %}
        {% set sort_pm = output.pm_prices | sort(reverse=True) %}
        
        {% set am_avg = 0 %}
        {% if sort_am | length > 0 %}
           {% set count = [sort_am|length, peak_hours_count] | min %}
           {% set am_avg = (sort_am[:count] | sum / count) %}
        {% endif %}
        
        {% set pm_avg = 0 %}
        {% if sort_pm | length > 0 %}
           {% set count = [sort_pm|length, peak_hours_count] | min %}
           {% set pm_avg = (sort_pm[:count] | sum / count) %}
        {% endif %}

        {"all": {{ output.price_list }}, "slot_data": {{ output.slot_data }}, "am_peak": {{ am_avg }}, "pm_peak": {{ pm_avg }} }

      # Variables
      sorted_all: "{{ filtered_data.all | sort }}"
      
      # Determine Relevant Peak Reference
      relevant_peak_price: >-
        {% if is_night_now %} {{ filtered_data.am_peak }}
        {% else %} {{ filtered_data.pm_peak }}
        {% endif %}
      
      # Buffer Limit (Percentage)
      buffer_limit: "{{ relevant_peak_price * (1 - (buffer_discount_percentage / 100)) }}"

      # --- 4. TARGETS ---
      forecast_tomorrow_val: "{{ states(solar_forecast_tomorrow) | float(0) }}"
      relevant_solar: >-
        {% if now().hour >= 14 %} {{ forecast_tomorrow_val }}
        {% else %} {{ states(solar_forecast_today) | float(0) }}
        {% endif %}
      dynamic_target_soc: >-
        {% if relevant_solar > summer_solar_threshold %} {{ target_soc_summer }}
        {% else %} {{ target_soc_winter }}
        {% endif %}

      # --- 5. CHARGE CEILING (STRICT) ---
      charge_limit_strict: >-
        {% set deficit = dynamic_target_soc - current_soc %}
        {% if deficit > 0 %}
           {% set kwh_needed = (deficit / 100.0) * battery_capacity_kwh %}
           {% set hours_needed = (kwh_needed / charge_power_kw * safety_factor) | round(0, 'ceil') | int %}
           {% if sorted_all | length > 0 %}
             {% set idx = (hours_needed - 1) if (hours_needed - 1) < sorted_all|length else (sorted_all|length - 1) %}
             {{ sorted_all[idx] }}
           {% else %} -999 {% endif %}
        {% else %} -999 {% endif %}

      # --- 6. DISCHARGE THRESHOLD (PERCENTAGE) ---
      discharge_start_price: "{{ last_paid_price * (1 + (min_discharge_margin / 100)) }}"

  - choose:
      # --- PRIORITY 1: REPORTING ---
      - conditions:
          - condition: trigger
            id: "report"
        sequence:
          - if:
              - condition: template
                value_template: "{{ has_notify_device }}"
            then:
              - domain: mobile_app
                type: notify
                device_id: !input notify_device
                message: >-
                  {% if language == 'nl' %}
                    ðŸ“Š **Batterij Rapport**
                    
                    ðŸ”‹ **Status**
                    Huidig: {{ current_soc }}% | Doel: {{ dynamic_target_soc }}%
                    Ochtend Buffer: {{ target_soc_morning_min }}%
                    
                    ðŸ’° **Financieel**
                    Strikt (<): â‚¬{{ charge_limit_strict | round(3) }}
                    Buffer (<): â‚¬{{ buffer_limit | round(3) }}
                    AM Piek: â‚¬{{ filtered_data.am_peak | round(3) }} | PM Piek: â‚¬{{ filtered_data.pm_peak | round(3) }}
                    
                    ðŸ•’ **Starttijden**
                    {%- set ns_list = namespace(found=[]) %}
                    {%- for item in filtered_data.slot_data %}
                      {%- set h = item.local_hour %}
                      {%- set is_night_item = false %}
                      {%- if night_crosses %}
                        {%- set is_night_item = (h >= ns or h < ne) %}
                      {%- else %}
                        {%- set is_night_item = (h >= ns and h < ne) %}
                      {%- endif %}
                      
                      {%- if item.price <= charge_limit_strict %}
                        {%- set ns_list.found = ns_list.found + [item.day_str ~ " " ~ item.local_hour ~ ":00 (â‚¬" ~ item.price|round(3) ~ ") [Strikt]"] %}
                      {%- elif item.price <= buffer_limit %}
                        {%- set ns_list.found = ns_list.found + [item.day_str ~ " " ~ item.local_hour ~ ":00 (Buffer)"] %}
                      {%- elif is_night_item and item.price < max_price_cap and current_soc < target_soc_morning_min %}
                        {%- set ns_list.found = ns_list.found + [item.day_str ~ " " ~ item.local_hour ~ ":00 (Ochtend)"] %}
                      {%- endif %}
                    {%- endfor %}
                    {{ ns_list.found | join('\n') if ns_list.found else "Geen." }}
                  {% else %}
                    ðŸ“Š **Battery Plan**
                    
                    ðŸ”‹ **Status**
                    Current: {{ current_soc }}% | Target: {{ dynamic_target_soc }}%
                    Morning Buffer: {{ target_soc_morning_min }}%
                    
                    ðŸ’° **Financial**
                    Strict (<): â‚¬{{ charge_limit_strict | round(3) }}
                    Buffer (<): â‚¬{{ buffer_limit | round(3) }}
                    AM Peak: â‚¬{{ filtered_data.am_peak | round(3) }} | PM Peak: â‚¬{{ filtered_data.pm_peak | round(3) }}
                    
                    ðŸ•’ **Schedule**
                    {%- set ns_list = namespace(found=[]) %}
                    {%- for item in filtered_data.slot_data %}
                      {%- set h = item.local_hour %}
                      {%- set is_night_item = false %}
                      {%- if night_crosses %}
                        {%- set is_night_item = (h >= ns or h < ne) %}
                      {%- else %}
                        {%- set is_night_item = (h >= ns and h < ne) %}
                      {%- endif %}
                      
                      {%- if item.price <= charge_limit_strict %}
                        {%- set ns_list.found = ns_list.found + [item.day_str ~ " " ~ item.local_hour ~ ":00 (â‚¬" ~ item.price|round(3) ~ ") [Strict]"] %}
                      {%- elif item.price <= buffer_limit %}
                        {%- set ns_list.found = ns_list.found + [item.day_str ~ " " ~ item.local_hour ~ ":00 (Buffer)"] %}
                      {%- elif is_night_item and item.price < max_price_cap and current_soc < target_soc_morning_min %}
                        {%- set ns_list.found = ns_list.found + [item.day_str ~ " " ~ item.local_hour ~ ":00 (Morning)"] %}
                      {%- endif %}
                    {%- endfor %}
                    {{ ns_list.found | join('\n') if ns_list.found else "No slots found." }}
                  {% endif %}

      # --- PRIORITY 2: BOOST ---
      - conditions:
          - condition: template
            value_template: "{{ is_boost_active }}"
        sequence:
          - service: number.set_value
            target:
              entity_id: !input target_soc_number
            data:
              value: 100
          - service: switch.turn_on
            target:
              entity_id: !input battery_reserve_switch

      # --- PRIORITY 3: EMERGENCY ---
      - conditions:
          - condition: template
            value_template: "{{ current_soc < min_base_soc }}"
          - condition: template
            value_template: "{{ current_price < (max_price_cap * 1.5) }}"
        sequence:
          - service: number.set_value
            target:
              entity_id: !input target_soc_number
            data:
              value: "{{ min_base_soc }}"
          - service: switch.turn_on
            target:
              entity_id: !input battery_reserve_switch
          - service: input_number.set_value
            target:
              entity_id: !input last_price_helper
            data:
              value: "{{ current_price }}"

      # --- PRIORITY 4: CHARGING ---
      - conditions:
          - condition: or
            conditions:
              # A. MORNING GUARANTEE
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ is_night_now }}"
                  - condition: template
                    value_template: "{{ current_soc < target_soc_morning_min }}"
                  - condition: template
                    value_template: "{{ current_price < max_price_cap }}"
              
              # B. SMART BUFFER
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ is_in_slot }}"
                  - condition: template
                    value_template: "{{ current_price <= buffer_limit }}"
                  - condition: template
                    value_template: "{{ current_soc < dynamic_target_soc }}"
              
              # C. STRICTLY NEEDED
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ is_in_slot }}"
                  - condition: template
                    value_template: "{{ current_price <= charge_limit_strict }}"
                  - condition: template
                    value_template: "{{ current_soc < dynamic_target_soc }}"
        sequence:
          - service: number.set_value
            target:
              entity_id: !input target_soc_number
            data:
              value: "{{ dynamic_target_soc }}"
          - service: switch.turn_on
            target:
              entity_id: !input battery_reserve_switch
          - service: input_number.set_value
            target:
              entity_id: !input last_price_helper
            data:
              value: "{{ current_price }}"
          # Notification
          - if:
              - condition: template
                value_template: "{{ has_notify_device }}"
              - condition: template
                value_template: >-
                  {% if states[battery_reserve_switch].last_changed %}
                    {{ (as_timestamp(now()) - as_timestamp(states[battery_reserve_switch].last_changed)) > 3600 }}
                  {% else %} true {% endif %}
            then:
              - domain: mobile_app
                type: notify
                device_id: !input notify_device
                message: >-
                  {% if language == 'nl' %}
                    ðŸŸ¢ Start Laden (â‚¬{{ current_price | round(3) }})
                    Ref Piek: â‚¬{{ relevant_peak_price | round(3) }}
                  {% else %}
                    ðŸŸ¢ Start Charging (â‚¬{{ current_price | round(3) }})
                    Ref Peak: â‚¬{{ relevant_peak_price | round(3) }}
                  {% endif %}

      # --- PRIORITY 5: DISCHARGING ---
      - conditions:
          - condition: template
            value_template: "{{ current_price >= discharge_start_price }}"
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input battery_reserve_switch
          # Un-anchor
          - if:
              - condition: template
                value_template: "{{ (states(target_soc_number)|float(0) - min_base_soc)|abs > 1 }}"
            then:
              - service: number.set_value
                target:
                  entity_id: !input target_soc_number
                data:
                  value: "{{ min_base_soc | int }}"

      # --- PRIORITY 6: HOLD ---
      - conditions:
          - condition: template
            value_template: "{{ current_price > charge_limit_strict }}"
          - condition: template
            value_template: "{{ current_price < discharge_start_price }}"
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input battery_reserve_switch
          # Ratchet Logic
          - if:
              - condition: template
                value_template: "{{ (states(target_soc_number)|float(0) - current_soc) > 2 }}"
            then:
              - service: number.set_value
                target:
                  entity_id: !input target_soc_number
                data:
                  value: "{{ current_soc | int }}"
              - if:
                  - condition: template
                    value_template: "{{ has_notify_device }}"
                  - condition: template
                    value_template: >-
                      {% if states[battery_reserve_switch].last_changed %}
                        {{ (as_timestamp(now()) - as_timestamp(states[battery_reserve_switch].last_changed)) > 3600 }}
                      {% else %} true {% endif %}
                then:
                  - domain: mobile_app
                    type: notify
                    device_id: !input notify_device
                    message: "{{ 'ðŸŸ¡ Smart Hold' if language == 'nl' else 'ðŸŸ¡ Smart Hold' }}"

mode: single