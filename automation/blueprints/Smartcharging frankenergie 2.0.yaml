blueprint:
  name: Frank Energie - Slim Laden V11 (Boost & Rendement)
  description: >
    Geavanceerde batterijsturing voor Frank Energie.
    
    FUNCTIES:
    1. Slimme Planning: Kijkt naar prijzen van vandaag Ã©n morgen.
    2. Seizoensmodus: Houdt ruimte vrij voor zon in de zomer (Day-Ahead).
    3. Rendementscheck: Laadt 'extra' buffer alleen als de winstmarge groot genoeg is.
    4. Boost Knop: Handmatige override om direct vol te laden.
    5. Notificaties: Bericht op je telefoon bij start laden.
  domain: automation
  input:
    # --- BASIS ENTITEITEN ---
    battery_reserve_switch:
      name: "Schakelaar: Geforceerd Laden"
      description: "De schakelaar die de batterij dwingt om te laden vanuit het net (bijv. 'Force Charge' of 'Reserve Mode')."
      selector:
        entity:
          domain: switch
    battery_soc_sensor:
      name: "Sensor: Batterij Percentage (SoC)"
      description: "De sensor die aangeeft hoe vol de batterij nu is."
      selector:
        entity:
          domain: sensor
          device_class: battery
    frank_price_sensor:
      name: "Sensor: Frank Energie Prijzen"
      description: "De sensor van de Frank Energie integratie die het attribuut 'prices' bevat (toekomstige prijzen)."
      selector:
        entity:
          domain: sensor

    # --- BOOST & NOTIFICATIES ---
    boost_switch:
      name: "Optie: Boost Schakelaar"
      description: "Selecteer een (virtuele) schakelaar. Als je deze AAN zet, negeert het systeem alle regels en gaat de batterij direct laden tot hij vol is."
      default: []
      selector:
        entity:
          domain: input_boolean
    notify_device:
      name: "Optie: Telefoon voor meldingen"
      description: "Selecteer je telefoon. Je krijgt een eenmalig berichtje zodra het slim laden start."
      default: []
      selector:
        device:
          integration: mobile_app

    # --- ZON VOORSPELLING ---
    solar_forecast_today:
      name: "Sensor: Zonvoorspelling VANDAAG"
      description: "Sensor die de verwachte opbrengst van VANDAAG in kWh aangeeft."
      selector:
        entity:
          domain: sensor
    solar_forecast_tomorrow:
      name: "Sensor: Zonvoorspelling MORGEN"
      description: "Sensor die de verwachte opbrengst van MORGEN in kWh aangeeft (voor nachtplanning)."
      selector:
        entity:
          domain: sensor
    summer_solar_threshold:
      name: "Drempelwaarde Zonnige Dag (kWh)"
      description: >
        Vanaf hoeveel kWh zonopbrengst beschouw je een dag als 'zonnig'?
        Boven deze waarde schakelt het systeem naar 'Zomer Doel' (ruimte vrijhouden).
        Hieronder gebruikt hij 'Winter Doel' (volgooien).
      default: 15
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "kWh"

    # --- RENDEMENT & MARGES ---
    min_profit_margin:
      name: "Minimale Winstmarge (%)"
      description: >
        Om laadverliezen te compenseren.
        De 'extra' buffer-uren worden ALLEEN geladen als de stroomprijs minimaal X% lager is dan het daggemiddelde.
        Voorbeeld: Bij 20% marge en een gemiddelde van â‚¬0,30, laadt hij de buffer alleen als de prijs onder de â‚¬0,24 ligt.
      default: 20
      selector:
        number:
          min: 0
          max: 50
          unit_of_measurement: "%"

    # --- DOEL PERCENTAGES ---
    target_soc_winter:
      name: "Doel SoC: Winter / Donker (%)"
      description: "Tot hoe ver laden als er WEINIG zon wordt verwacht? (Advies: 90-100%)."
      default: 90
      selector:
        number:
          min: 10
          max: 100
          unit_of_measurement: "%"
    target_soc_summer:
      name: "Doel SoC: Zomer / Zonnig (%)"
      description: "Tot hoe ver laden als er VEEL zon wordt verwacht? Houd dit laag om ruimte te laten voor gratis zonnestroom. (Advies: 20-40%)."
      default: 30
      selector:
        number:
          min: 10
          max: 100

    # --- BATTERIJ SPECIFICATIES ---
    battery_capacity_kwh:
      name: "Batterij Capaciteit (kWh)"
      description: "De totale opslagcapaciteit van je thuisbatterij."
      default: 10
      selector:
        number:
          min: 1
          max: 100
          step: 0.1
          unit_of_measurement: "kWh"
    charge_power_kw:
      name: "Laadsnelheid (kW)"
      description: "Met hoeveel kW kan je systeem laden? (Bijv. 3000 Watt = 3.0)."
      default: 3.0
      selector:
        number:
          min: 0.1
          max: 22
          step: 0.1
          unit_of_measurement: "kW"
    safety_factor:
      name: "BMS Vertragingsfactor"
      description: >
        Reserveert extra laadtijd voor als de batterij traag laadt (kou/balanceren).
        1.0 = Geen reserve.
        1.5 = 50% extra tijd (alleen gebruikt bij goede prijzen).
        2.0 = Dubbele tijd reserveren (Aanbevolen bij knijpende BMS).
      default: 1.5
      selector:
        number:
          min: 1.0
          max: 4.0
          step: 0.1

    # --- VEILIGHEID ---
    max_price_cap:
      name: "Absolute Maximumprijs (â‚¬)"
      description: "Boven deze prijs wordt er NOOIT geladen, zelfs niet als de batterij leeg is (tenzij Boost aan staat)."
      default: 0.35
      selector:
        number:
          min: 0
          max: 2.0
          step: 0.01
          mode: box
          unit_of_measurement: "â‚¬"
    emergency_soc:
      name: "Noodgrens SoC (%)"
      description: "Als de batterij onder dit percentage komt, wordt er altijd geladen om uitval te voorkomen."
      default: 10
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"

variables:
  # Koppel inputs aan variabelen voor gebruik in templates
  battery_reserve_switch: !input battery_reserve_switch
  battery_soc_sensor: !input battery_soc_sensor
  frank_price_sensor: !input frank_price_sensor
  boost_switch: !input boost_switch
  notify_device: !input notify_device
  solar_forecast_today: !input solar_forecast_today
  solar_forecast_tomorrow: !input solar_forecast_tomorrow
  summer_solar_threshold: !input summer_solar_threshold
  min_profit_margin: !input min_profit_margin
  target_soc_winter: !input target_soc_winter
  target_soc_summer: !input target_soc_summer
  battery_capacity_kwh: !input battery_capacity_kwh
  charge_power_kw: !input charge_power_kw
  safety_factor: !input safety_factor
  max_price_cap: !input max_price_cap
  emergency_soc: !input emergency_soc

trigger:
  - platform: time_pattern
    minutes: "/5"
  - platform: state
    entity_id: !input frank_price_sensor
  # Trigger direct als Boost wordt aangezet
  - platform: state
    entity_id: !input boost_switch
    to: "on"

action:
  - variables:
      current_soc: "{{ states(battery_soc_sensor) | float(0) }}"
      current_price: "{{ states(frank_price_sensor) | float(0) }}"
      # Controleer of Boost Switch is ingesteld en AAN staat
      is_boost_active: "{{ boost_switch != [] and is_state(boost_switch, 'on') }}"
      
      # 1. ZON: Bepaal of we vandaag of morgen moeten bekijken
      forecast_tomorrow_val: "{{ states(solar_forecast_tomorrow) | float(0) }}"
      relevant_solar: >-
        {% if now().hour >= 14 %} {{ forecast_tomorrow_val }}
        {% else %} {{ states(solar_forecast_today) | float(0) }}
        {% endif %}
      
      # 2. DOEL: Bepaal SoC doel op basis van zon
      dynamic_target_soc: >-
        {% if relevant_solar > summer_solar_threshold %} {{ target_soc_summer }}
        {% else %} {{ target_soc_winter }}
        {% endif %}

      # 3. UREN: Bereken benodigde uren (Strikt vs Veilig)
      hours_calc: >-
        {% set soc_deficit = dynamic_target_soc - current_soc %}
        {% if soc_deficit > 0 %}
           {% set kwh_needed = (soc_deficit / 100.0) * battery_capacity_kwh %}
           {% set strict = (kwh_needed / charge_power_kw) | round(0, 'ceil') | int %}
           {% set safe = (strict * safety_factor) | round(0, 'ceil') | int %}
           {"strict": {{ strict }}, "safe": {{ safe }}}
        {% else %}
           {"strict": 0, "safe": 0}
        {% endif %}
      hours_strict: "{{ hours_calc.strict }}"
      hours_safe: "{{ hours_calc.safe }}"

      # 4. DATA: Haal prijzen op en bereken gemiddelde
      price_data: >-
        {% set raw_prices = state_attr(frank_price_sensor, 'prices') %}
        {% set output = namespace(list=[], avg=0) %}
        {% if raw_prices %}
           {% set text = raw_prices | string %}
           {% set matches = text | regex_findall("from_hour': (\\d+).*?price': ([0-9.]+)") %}
           {% for m in matches %}
              {% set output.list = output.list + [m[1]|float] %}
           {% endfor %}
        {% endif %}
        {% if output.list | length > 0 %}
          {% set output.avg = (output.list | sum / output.list | length) %}
        {% endif %}
        {"list": {{ output.list }}, "avg": {{ output.avg }}}
      
      sorted_prices: "{{ price_data.list | sort }}"
      avg_price: "{{ price_data.avg }}"

      # 5. DREMPELS: Bepaal prijslimieten
      # Maximale prijs voor buffer-uren (Gemiddelde minus winstmarge)
      profit_price_limit: "{{ avg_price * (1 - (min_profit_margin / 100)) }}"

      # Drempel Strict (Must run)
      threshold_strict: >-
        {% if sorted_prices | length > 0 and hours_strict > 0 %}
           {% set idx = (hours_strict - 1) if (hours_strict - 1) < sorted_prices|length else (sorted_prices|length - 1) %}
           {{ sorted_prices[idx] }}
        {% else %} -999 {% endif %}

      # Drempel Safe (Alleen als goedkoop)
      threshold_safe: >-
        {% if sorted_prices | length > 0 and hours_safe > 0 %}
           {% set idx = (hours_safe - 1) if (hours_safe - 1) < sorted_prices|length else (sorted_prices|length - 1) %}
           {{ sorted_prices[idx] }}
        {% else %} -999 {% endif %}

  - choose:
      # SCENARIO 1: BOOST MODUS (Handmatige Override)
      - conditions:
          - condition: template
            value_template: "{{ is_boost_active }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ is_state(battery_reserve_switch, 'off') }}"
            then:
              - service: switch.turn_on
                target:
                  entity_id: !input battery_reserve_switch
              - if:
                  - condition: template
                    value_template: "{{ notify_device != [] }}"
                then:
                  - domain: mobile_app
                    type: notify
                    device_id: !input notify_device
                    message: "ðŸš€ Boost geactiveerd! Batterij laadt nu maximaal."

      # SCENARIO 2: NOOD (Batterij kritiek laag)
      - conditions:
          - condition: template
            value_template: "{{ current_soc < emergency_soc }}"
          - condition: template
            value_template: "{{ current_price < (max_price_cap * 1.5) }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ is_state(battery_reserve_switch, 'off') }}"
            then:
              - service: switch.turn_on
                target:
                  entity_id: !input battery_reserve_switch
              - if:
                  - condition: template
                    value_template: "{{ notify_device != [] }}"
                then:
                  - domain: mobile_app
                    type: notify
                    device_id: !input notify_device
                    message: "âš ï¸ Noodlading gestart (SoC < {{ emergency_soc }}%)."

      # SCENARIO 3: SLIM LADEN (Strict & Buffer)
      - conditions:
          - condition: or
            conditions:
              # A: Strikte uren (De allergoedkoopste)
              - condition: template
                value_template: "{{ current_price <= threshold_strict }}"
              
              # B: Buffer uren (Alleen als prijs lager is dan Winst-limiet)
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ current_price <= threshold_safe }}"
                  - condition: template
                    value_template: "{{ current_price < profit_price_limit }}"
          
          # Algemene checks
          - condition: template
            value_template: "{{ current_price < max_price_cap }}"
          - condition: template
            value_template: "{{ current_soc < dynamic_target_soc }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ is_state(battery_reserve_switch, 'off') }}"
            then:
              - service: switch.turn_on
                target:
                  entity_id: !input battery_reserve_switch
              # Notificatie
              - if:
                  - condition: template
                    value_template: "{{ notify_device != [] }}"
                then:
                  - domain: mobile_app
                    type: notify
                    device_id: !input notify_device
                    message: >-
                      ðŸ”‹ Slim laden gestart! 
                      Prijs: â‚¬{{ current_price | round(3) }}.
                      Doel: {{ dynamic_target_soc }}%.
                      Type: {{ 'Strikt (Noodzakelijk)' if current_price <= threshold_strict else 'Buffer (Winstgevend)' }}

      # SCENARIO 4: STOPPEN
      - conditions:
          - condition: template
            value_template: "{{ is_state(battery_reserve_switch, 'on') }}"
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input battery_reserve_switch

mode: single